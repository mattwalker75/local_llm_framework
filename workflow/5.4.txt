

5.4 Add Prompt Templates and Management
What: Create, manage, and reuse prompt templates for common tasks. Explanation: Users often use similar prompts repeatedly (code review, summarization, translation, etc.). This feature enables:
Template Library: Pre-built templates for common tasks
Custom Templates: Create and save custom templates
Variable Substitution: Templates with placeholders
Template Versioning: Track and update templates
Template Sharing: Export/import templates
Benefits:
Consistent prompt quality
Save time on repeated tasks
Share best practices
Easy prompt iteration
Files to Update:
llf/prompt_templates.py (new file)
llf/cli.py
llf/gui.py
templates/ directory (new)
Implementation Guide:
Step 1: Create Prompt Template Manager
Create new f not self.updated_at:
            self.updated_at = self.created_at


class PromptTemplateManager:
    """Manages prompt templates."""
    
    def __init__(self, templates_dir: Optional[Path] = None):
        """
        Initialize template manager.
        
        Args:
            templates_dir: Directory for template storage
        """
        self.templates_dir = templates_dir or (Path.home() / '.llf' / 'templates')
        self.templates_dir.mkdir(parents=True, exist_ok=True)
        
        self.templates: Dict[str, PromptTemplate] = {}
        self._load_templates()
        self._load_builtin_templates()
    
    def _load_templates(self) -> None:
        """Load templates from disk."""
        for template_file in self.templates_dir.glob('*.json'):
            try:
                with open(template_file, 'r') as f:
                    data = json.load(f)
                
                template = PromptTemplate(**data)
                self.templates[template.id] = template
                
            except Exception as e:
                logger.error(f"Failed to load template {template_file}: {str(e)}")
    
    def _load_builtin_templates(self) -> None:
        """Load built-in templates."""
        builtin = [
            PromptTemplate(
                id="code_review",
                name="Code Review",
                description="Review code for bugs, style, and best practices",
                template="""Please review the following code:

```{language}
{code}
Focus on:
Bugs and potential issues
Code style and readability
Performance concerns
Best practices
Security vulnerabilities
Provide specific suggestions for improvement.""", variables=["language", "code"], category="development", tags=["code", "review", "quality"], author="llf-builtin" ),

        PromptTemplate(
            id="summarize_text",
            name="Summarize Text",
            description="Create a concise summary of text",
            template="""Please summarize the following text in {length} sentences:
{text} Focus on the key points and main ideas.""", variables=["text", "length"], category="writing", tags=["summary", "text", "writing"], author="llf-builtin" ),

        PromptTemplate(
            id="explain_code",
            name="Explain Code",
            description="Explain what code does in plain language",
            template="""Please explain what this {language} code does in plain language:

{code}
Explain:
The overall purpose
How it works step-by-step
Any important details or gotchas""", variables=["language", "code"], category="development", tags=["code", "explain", "documentation"], author="llf-builtin" ),

     PromptTemplate(
         id="translate_text",
         name="Translate Text",
         description="Translate text between languages",
         template="""Please translate the following text from {source_lang} to {target_lang}:
{text} Maintain the tone and style of the original.""", variables=["source_lang", "target_lang", "text"], category="language", tags=["translation", "language"], author="llf-builtin" ),

        PromptTemplate(
            id="debug_error",
            name="Debug Error",
            description="Help debug an error or exception",
            template="""I'm getting the following error:

{error_message}
Context: {context} Please help me:
Understand what's causing the error
Provide potential solutions
Explain how to prevent it in the future""", variables=["error_message", "context"], category="development", tags=["debug", "error", "troubleshooting"], author="llf-builtin" ),

     PromptTemplate(
         id="write_tests",
         name="Write Unit Tests",
         description="Generate unit tests for code",
         template="""Please write unit tests for the following {language} code:

{code}
Requirements:
Use {test_framework}
Cover edge cases
Include both positive and negative tests
Add docstrings""", variables=["language", "code", "test_framework"], category="development", tags=["testing", "unit-tests", "code"], author="llf-builtin" ),

      PromptTemplate(
          id="refactor_code",
          name="Refactor Code",
          description="Suggest code refactoring improvements",
          template="""Please suggest refactorings for this {language} code:

{code}
Focus on:
Improving readability
Reducing complexity
Better naming
Design patterns
Maintainability
Explain each suggestion.""", variables=["language", "code"], category="development", tags=["refactor", "code-quality", "code"], author="llf-builtin" ), ]

    # Only add if not already present
    for template in builtin:
        if template.id not in self.templates:
            self.templates[template.id] = template

def create_template(
    self,
    name: str,
    template: str,
    description: str,
    category: str,
    tags: Optional[List[str]] = None,
    author: Optional[str] = None
) -> str:
    """
    Create a new template.
    
    Args:
        name: Template name
        template: Template text with {variables}
        description: Template description
        category: Category (development, writing, etc.)
        tags: Optional tags
        author: Optional author
    
    Returns:
        Template ID
    """
    # Extract variables from template
    variables = re.findall(r'\{(\w+)\}', template)
    
    # Generate ID
    template_id = name.lower().replace(' ', '_')
    
    # Create template
    prompt_template = PromptTemplate(
        id=template_id,
        name=name,
        description=description,
        template=template,
        variables=list(set(variables)),
        category=category,
        tags=tags or [],
        author=author
    )
    
    self.templates[template_id] = prompt_template
    self._save_template(prompt_template)
    
    logger.info(f"Created template: {template_id}")
    return template_id

def get_template(self, template_id: str) -> Optional[PromptTemplate]:
    """Get template by ID."""
    return self.templates.get(template_id)

def list_templates(
    self,
    category: Optional[str] = None,
    tags: Optional[List[str]] = None
) -> List[PromptTemplate]:
    """
    List templates with optional filtering.
    
    Args:
        category: Filter by category
        tags: Filter by tags (any match)
    
    Returns:
        List of matching templates
    """
    templates = list(self.templates.values())
    
    if category:
        templates = [t for t in templates if t.category == category]
    
    if tags:
        templates = [
            t for t in templates
            if any(tag in t.tags for tag in tags)
        ]
    
    return sorted(templates, key=lambda t: t.name)

def render_template(
    self,
    template_id: str,
    variables: Dict[str, str]
) -> str:
    """
    Render template with variable substitution.
    
    Args:
        template_id: Template ID
        variables: Variable values
    
    Returns:
        Rendered prompt
    
    Raises:
        ValueError: If template not found or missing variables
    """
    template = self.get_template(template_id)
    if not template:
        raise ValueError(f"Template not found: {template_id}")
    
    # Check for missing variables
    missing = set(template.variables) - set(variables.keys())
    if missing:
        raise ValueError(f"Missing variables: {missing}")
    
    # Render
    rendered = template.template
    for var_name, var_value in variables.items():
        rendered = rendered.replace(f"{{{var_name}}}", str(var_value))
    
    # Increment usage count
    template.usage_count += 1
    self._save_template(template)
    
    return rendered

def update_template(
    self,
    template_id: str,
    **kwargs
) -> bool:
    """
    Update template fields.
    
    Args:
        template_id: Template ID
        **kwargs: Fields to update
    
    Returns:
        True if successful
    """
    template = self.get_template(template_id)
    if not template:
        return False
    
    # Update fields
    for key, value in kwargs.items():
        if hasattr(template, key):
            setattr(template, key, value)
    
    template.updated_at = datetime.utcnow().isoformat()
    self._save_template(template)
    
    return True

def delete_template(self, template_id: str) -> bool:
    """Delete template."""
    if template_id not in self.templates:
        return False
    
    # Don't delete built-in templates
    template = self.templates[template_id]
    if template.author == "llf-builtin":
        logger.warning(f"Cannot delete built-in template: {template_id}")
        return False
    
    del self.templates[template_id]
    
    # Delete file
    template_file = self.templates_dir / f"{template_id}.json"
    if template_file.exists():
        template_file.unlink()
    
    return True

def export_template(self, template_id: str, output_path: Path) -> bool:
    """Export template to file."""
    template = self.get_template(template_id)
    if not template:
        return False
    
    with open(output_path, 'w') as f:
        json.dump(asdict(template), f, indent=2)
    
    return True

def import_template(self, input_path: Path) -> Optional[str]:
    """Import template from file."""
    try:
        with open(input_path, 'r') as f:
            data = json.load(f)
        
        template = PromptTemplate(**data)
        self.templates[template.id] = template
        self._save_template(template)
        
        return template.id
        
    except Exception as e:
        logger.error(f"Failed to import template: {str(e)}")
        return None

def _save_template(self, template: PromptTemplate) -> None:
    """Save template to disk."""
    # Don't save built-in templates
    if template.author == "llf-builtin":
        return
    
    template_file = self.templates_dir / f"{template.id}.json"
    with open(template_file, 'w') as f:
        json.dump(asdict(template), f, indent=2)

def get_categories(self) -> List[str]:
    """Get all template categories."""
    return sorted(set(t.category for t in self.templates.values()))

def get_stats(self) -> Dict[str, Any]:
    """Get template statistics."""
    return {
        'total_templates': len(self.templates),
        'categories': len(self.get_categories()),
        'total_usage': sum(t.usage_count for t in self.templates.values()),
        'most_used': max(self.templates.values(), key=lambda t: t.usage_count).name
    }


### Step 2: Add CLI Commands

In `llf/cli.py`, add template commands:

```python
def cmd_template_list(args):
    """List available templates."""
    from llf.prompt_templates import PromptTemplateManager
    
    manager = PromptTemplateManager()
    templates = manager.list_templates(category=args.category, tags=args.tags)
    
    if not templates:
        print("No templates found")
        return
    
    print(f"\n=== Prompt Templates ({len(templates)}) ===\n")
    
    # Group by category
    by_category = {}
    for template in templates:
        if template.category not in by_category:
            by_category[template.category] = []
        by_category[template.category].append(template)
    
    for category, category_templates in sorted(by_category.items()):
        print(f"{category.upper()}:")
        for template in category_templates:
            print(f"  {template.id}")
            print(f"    {template.description}")
            print(f"    Variables: {', '.join(template.variables)}")
            print(f"    Used: {template.usage_count} times")
            print()

def cmd_template_show(args):
    """Show template details."""
    from llf.prompt_templates import PromptTemplateManager
    
    manager = PromptTemplateManager()
    template = manager.get_template(args.template_id)
    
    if not template:
        print(f"Template not found: {args.template_id}")
        return
    
    print(f"\n=== Template: {template.name} ===\n")
    print(f"ID: {template.id}")
    print(f"Category: {template.category}")
    print(f"Tags: {', '.join(template.tags)}")
    print(f"Author: {template.author}")
    print(f"Version: {template.version}")
    print(f"Usage: {template.usage_count} times")
    print(f"\nDescription:")
    print(f"  {template.description}")
    print(f"\nVariables:")
    for var in template.variables:
        print(f"  - {var}")
    print(f"\nTemplate:")
    print(template.template)

def cmd_template_use(args):
    """Use a template with variable substitution."""
    from llf.prompt_templates import PromptTemplateManager
    
    manager = PromptTemplateManager()
    template = manager.get_template(args.template_id)
    
    if not template:
        print(f"Template not found: {args.template_id}")
        return
    
    # Collect variable values
    variables = {}
    
    if args.variables:
        # Parse from command line: var1=value1,var2=value2
        for pair in args.variables.split(','):
            if '=' in pair:
                key, value = pair.split('=', 1)
                variables[key.strip()] = value.strip()
    else:
        # Interactive mode
        print(f"Template: {template.name}")
        print(f"Variables required: {', '.join(template.variables)}\n")
        
        for var in template.variables:
            value = input(f"{var}: ")
            variables[var] = value
    
    # Render
    try:
        rendered = manager.render_template(args.template_id, variables)
        
        print("\n=== Rendered Prompt ===\n")
        print(rendered)
        
        # Optionally send to LLM
        if args.execute:
            print("\n=== LLM Response ===\n")
            config = Config()
            runtime = LLMRuntime(config)
            response = runtime.chat(messages=[{'role': 'user', 'content': rendered}])
            print(response.choices[0].message.content)
    
    except ValueError as e:
        print(f"Error: {str(e)}")

def cmd_template_create(args):
    """Create a new template."""
    from llf.prompt_templates import PromptTemplateManager
    
    manager = PromptTemplateManager()
    
    print("Create New Template\n")
    
    name = input("Name: ")
    description = input("Description: ")
    category = input("Category: ")
    tags = input("Tags (comma-separated): ").split(',')
    
    print("\nEnter template (use {variable_name} for variables):")
    print("Press Ctrl+D (Unix) or Ctrl+Z (Windows) when done:")
    
    lines = []
    try:
        while True:
            line = input()
            lines.append(line)
    except EOFError:
        pass
    
    template = '\n'.join(lines)
    
    template_id = manager.create_template(
        name=name,
        template=template,
        description=description,
        category=category,
        tags=[t.strip() for t in tags if t.strip()]
    )
    
    print(f"\nTemplate created: {template_id}")

def cmd_template_stats(args):
    """Show template statistics."""
    from llf.prompt_templates import PromptTemplateManager
    
    manager = PromptTemplateManager()
    stats = manager.get_stats()
    
    print("\n=== Template Statistics ===\n")
    print(f"Total Templates: {stats['total_templates']}")
    print(f"Categories: {stats['categories']}")
    print(f"Total Usage: {stats['total_usage']}")
    print(f"Most Used: {stats['most_used']}")

# Add to argparse
template_parser = subparsers.add_parser('template', help='Prompt template management')
template_subparsers = template_parser.add_subparsers(dest='template_command')

list_parser = template_subparsers.add_parser('list', help='List templates')
list_parser.add_argument('--category', help='Filter by category')
list_parser.add_argument('--tags', help='Filter by tags (comma-separated)')

show_parser = template_subparsers.add_parser('show', help='Show template details')
show_parser.add_argument('template_id', help='Template ID')

use_parser = template_subparsers.add_parser('use', help='Use template')
use_parser.add_argument('template_id', help='Template ID')
use_parser.add_argument('--variables', help='Variables (var1=val1,var2=val2)')
use_parser.add_argument('--execute', action='store_true', help='Send to LLM')

create_parser = template_subparsers.add_parser('create', help='Create template')

stats_parser = template_subparsers.add_parser('stats', help='Show statistics')
Step 3: Add to GUI
In llf/gui.py, add template interface:

def create_template_interface():
    """Create template management interface."""
    from llf.prompt_templates import PromptTemplateManager
    
    manager = PromptTemplateManager()
    
    def get_template_list(category):
        """Get templates for dropdown."""
        templates = manager.list_templates(category=category if category != "All" else None)
        return [t.id for t in templates]
    
    def show_template(template_id):
        """Show template details."""
        template = manager.get_template(template_id)
        if not template:
            return "Template not found"
        
        details = f"""# {template.name}

**Category:** {template.category}  
**Tags:** {', '.join(template.tags)}  
**Usage:** {template.usage_count} times

{template.description}

## Variables
{', '.join(template.variables)}

## Template
{template.template}

"""
        return details
    
    def use_template(template_id, *variable_values):
        """Render and use template."""
        template = manager.get_template(template_id)
        if not template:
            return "Template not found"
        
        # Build variables dict
        variables = dict(zip(template.variables, variable_values))
        
        try:
            rendered = manager.render_template(template_id, variables)
            return rendered
        except ValueError as e:
            return f"Error: {str(e)}"
    
    with gr.Blocks() as interface:
        gr.Markdown("## Prompt Template Manager")
        
        with gr.Row():
            category_dropdown = gr.Dropdown(
                choices=["All"] + manager.get_categories(),
                value="All",
                label="Category"
            )
            template_dropdown = gr.Dropdown(
                choices=[],
                label="Template"
            )
        
        template_details = gr.Markdown()
        
        # Dynamic variable inputs
        variable_inputs = []
        with gr.Column(visible=False) as variables_section:
            gr.Markdown("### Variables")
            for i in range(5):  # Max 5 variables displayed
                var_input = gr.Textbox(label=f"Variable {i+1}", visible=False)
                variable_inputs.append(var_input)
        
        render_btn = gr.Button("Render Template")
        rendered_output = gr.Textbox(label="Rendered Prompt", lines=10)
        
        send_btn = gr.Button("Send to LLM")
        response_output = gr.Markdown(label="Response")
        
        # Event handlers
        category_dropdown.change(
            fn=get_template_list,
            inputs=category_dropdown,
            outputs=template_dropdown
        )
        
        template_dropdown.change(
            fn=show_template,
            inputs=template_dropdown,
            outputs=template_details
        )
    
    return interface

